---
title: "Exam LBGFS 2023 -- Problem 2"
output: html_notebook
---

Design of Problem 2 in the exam for LBGFS2023 is documented.


## Background
Use example 7.3 (p112 of Falconer 1996) on two loci affecting coloring of mize.


## Simulate Single Locus Data

### Frequencies and Values
The allele frequencies are specified by

```{r}
vec_maf <- c(0.4)
n_nr_loci <- length(vec_maf)
```


The genotypic values are given by 

```{r}
vec_a <- c(28.5)
vec_d <- c(3.72)
vec_alpha <- vec_a + vec_d * (1-2*vec_maf)
vec_alpha
```


### Genotypes
The genotypes are generated by

```{r}
set.seed(2715)
n_nr_obs <- 32
vec_geno_code <- c(0:2)
mat_geno_code <- matrix(nrow = n_nr_obs, ncol = n_nr_loci)
for (idx in 1:n_nr_loci){
  mat_geno_code[,idx] <- sample(vec_geno_code, 
                                  size = n_nr_obs, 
                                  replace = TRUE,
                                  prob = c((1-vec_maf[idx])^2, 
                                           2*vec_maf[idx]*(1-vec_maf[idx]),
                                           vec_maf[idx]^2))
}
mat_geno_code_bM1Z1 <- mat_geno_code - 1
mat_geno_code_bM1Z1
```

Get the matrix with heterozygous indicators

```{r}
mat_geno_het <- mat_geno_code
mat_geno_het[mat_geno_code != 1] <- 0
mat_geno_het
```


### Generate Observations
Observations are generated by the following code chunks

```{r}
n_intercept <- 53.1
n_res_sd <- 2.7
mat_obs <- n_intercept + mat_geno_code_bM1Z1 %*% vec_a + mat_geno_het %*% vec_d + rnorm(n_nr_obs, sd = n_res_sd)
mat_obs
```

What are properties of generated data

```{r}
summary(mat_obs[,1])
```


## Output
Write generated data to datafile

```{r}
vec_loc_name <- c("LocusC")
tbl_qg_data <- tibble::tibble(Animal = c(1:n_nr_obs))
for (idx in 1:n_nr_loci){
  tbl_qg_data <- dplyr::bind_cols(tbl_qg_data, tibble::tibble(CurLocus = mat_geno_code[,idx]))
  colnames(tbl_qg_data)[ncol(tbl_qg_data)] <- vec_loc_name[idx]
}
tbl_qg_data <- dplyr::bind_cols(tbl_qg_data, tibble::tibble(Pigmentation = round(mat_obs[,1], digits = 0)))
tbl_qg_data 
```

Write data to file

```{r}
s_data_path <- here::here("docs", "data", "exam_qg_single_locus_p2.csv")
s_delim_char <- ","
readr::write_delim(tbl_qg_data, file = s_data_path, delim = s_delim_char)
```


## Single Locus Analysis
Read the data

```{r}
s_delim_char <- ","
s_data_url <- "https://charlotte-ngs.github.io/lbgfs2023/data/exam_qg_single_locus_p2.csv"
tbl_one_loc <- readr::read_delim(s_data_url, delim = s_delim_char)
tbl_one_loc
```

Estimate MAF from data leads to

```{r}
n_maf_est <- mean(tbl_one_loc$LocusC)/2
n_maf_est
```


Fitting the regression through all points to reproduce the analysis of Figure 7.2 on p117 of Falconer1996

```{r}
lm_one_loc <- lm(Pigmentation ~ LocusC, data = tbl_one_loc)
(smry_one_loc <- summary(lm_one_loc))
```

```{r}
alpha <- smry_one_loc$coefficients["LocusC", "Estimate"]
```


From the above, we get that $\alpha = `r alpha`$. 

Genotypic values are obtained from 

```{r}
library(dplyr)
tbl_one_loc_homo <- tbl_one_loc %>%
  filter(LocusC != 1)
tbl_one_loc_homo
```

Fit regression through homozygous animals

```{r}
lm_one_loc_geno_val <- lm(Pigmentation ~ LocusC, data = tbl_one_loc_homo)
(smry_one_loc_geno_val <- summary(lm_one_loc_geno_val))
```


From the above, we get the genotype value $a$ to be

```{r}
(n_geno_val_a_est <- smry_one_loc_geno_val$coefficients["LocusC","Estimate"])
```

To get to the value $d$, we have to subtract the intercept and $a$ from the mean of the heterozygous genotypes.

```{r}
n_intercept_est <- smry_one_loc_geno_val$coefficients["(Intercept)","Estimate"]
n_mean_het <- mean(tbl_one_loc$Pigmentation[tbl_one_loc$LocusC == 1])
n_geno_val_d_est <- n_mean_het - n_intercept_est - n_geno_val_a_est
```

Hence $d = `r n_geno_val_d_est`$




## Simulate Data Two Loci

### Frequencies and Values
The allele frequencies are specified by

```{r}
vec_maf <- c(0.35, 0.40)
n_nr_loci <- length(vec_maf)
```


The genotypic values are given by 

```{r}
vec_a <- c(2.225, 28.5)
vec_d <- c(1.32, 3.72)
```


### Genotypes
The genotypes are generated by

```{r}
set.seed(2715)
n_nr_obs <- 32
vec_geno_code <- c(0:2)
mat_geno_code <- matrix(nrow = n_nr_obs, ncol = n_nr_loci)
for (idx in 1:n_nr_loci){
  mat_geno_code[,idx] <- sample(vec_geno_code, 
                                  size = n_nr_obs, 
                                  replace = TRUE,
                                  prob = c((1-vec_maf[idx])^2, 
                                           2*vec_maf[idx]*(1-vec_maf[idx]),
                                           vec_maf[idx]^2))
}
mat_geno_code_bM1Z1 <- mat_geno_code - 1
mat_geno_code_bM1Z1
```

Get the matrix with heterozygous indicators

```{r}
mat_geno_het <- mat_geno_code
mat_geno_het[mat_geno_code != 1] <- 0
mat_geno_het
```


### Generate Observations
Observations are generated by the following code chunks

```{r}
n_intercept <- 53.1
n_res_sd <- 2.7
mat_obs <- n_intercept + mat_geno_code_bM1Z1 %*% vec_a + mat_geno_het %*% vec_d + rnorm(n_nr_obs, sd = n_res_sd)
mat_obs
```

What are properties of generated data

```{r}
summary(mat_obs[,1])
```


## Output
Write generated data to datafile

```{r}
vec_loc_name <- c("Locus B", "LocusC")
tbl_qg_data <- tibble::tibble(Animal = c(1:n_nr_obs))
for (idx in 1:n_nr_loci){
  tbl_qg_data <- dplyr::bind_cols(tbl_qg_data, tibble::tibble(CurLocus = mat_geno_code[,idx]))
  colnames(tbl_qg_data)[ncol(tbl_qg_data)] <- vec_loc_name[idx]
}
tbl_qg_data <- dplyr::bind_cols(tbl_qg_data, tibble::tibble(Pigmentation = round(mat_obs[,1], digits = 0)))
tbl_qg_data 
```

Write data to file

```{r}
s_data_path <- here::here("docs", "data", "exam_qg_p2.csv")
s_delim_char <- ","
readr::write_delim(tbl_qg_data, file = s_data_path, delim = s_delim_char)
```


## Analysis
Read the data

```{r}
s_delim_char <- ","
s_data_url <- "https://charlotte-ngs.github.io/lbgfs2023/data/exam_qg_p2.csv"
tbl_two_loc <- readr::read_delim(s_data_url, delim = s_delim_char)
tbl_two_loc
```



